# Project4_VirtualMemory 实验过程文档

+ 说明：prj4中关于页表及页表项实现细节、用户页表设置和程序载入的流程、page fault处理流程、替换策略、以及线程的相关实现细节等见[design_review.md](design_review.md)，本文主要介绍实验过程中遇到的具体问题及解决错误



### 单核运行ps指令报错

1. 错误现象

   使用单核启动时，执行ps指令将会出错。

2. 调试过程

   由于上板和qemu都出现相同的错误，首先在qemu上使用gdb进行跟踪调试。发现在与`current_runing_1`进行比对时触发错误。查看初始化逻辑发现由于单核初始化并未设置从核的`current_running_1`，从而导致了错误。

   因此将从核初始化的`curreng_running_1`也在主核初始化时指定，从而使得`ps`命令能同时适配单双核启动情形。

3. 问题总结

   由于prj3支持双核后大部分功能都基于双核实现，应当对各函数相关初始条件进行检查，使其能够同时支持单双核启动。



### 从核启动错误

1. 错误现象

   qemu双核启动后，使主核在唤醒从核后阻塞，则从核在通过`sret`指令进入用户态时触发异常。

2. 调试过程
   + 初次报错为指令缺页异常，因此需要考虑各级页表和页表项的设置。使用gdb进行内存跟踪。
   + 在对shell进行`load_task_img`后，使用gdb沿着各级页表项进行跟踪，发现最终物理页框中存储的确为shell程序的起始几条指令，因此考虑其他地方对该查询路径或页表内容的更改。
   + 记录页表地址，并在`sret`指令前，再次沿该目录进行查找，发现顶级页表内容已经不一致。分析代码逻辑，可能是在实现其他功能时所指定的地址同改地址覆盖，导致对页表内容进行修改，从而产生错误。
   + 由于堵塞从核后，主核可以正常执行，因此分析该错误可能是由于从核特有的结构，进而发现从核栈指针地址初始值与内存分配的起始值相同。由于第一页将被分配为shell进程的顶级页表，则当从核进入异常入口进行上下文保存时，就会修改shell进程顶级目录的值。发现该问题后，一方面保证栈指针初始值不再为分配页基址加上页大小，从而避免设计到另一个页；另一方面将内存分配起始值后移一页。修改后再次进行gdb跟踪，页表值将保持不变。
   + 在完成上述修改后，报错由inst_page_fault指令页错误变为另一错误，且报错的scause为28，未在代码中进行定义。向助教反馈后，得知qemu的从核错误的开启了dasic功能，导致访问用户地址出错。更新qemu后，该错误解决。

3. 问题总结

   对于本次虚存实验，需要额外注意对页表和页表项内容的管理和维护。在出现与预期不符的页错误的时候，可以使用gdb进行跟踪确认。同时，需要防止不同功能之间产生的内存覆盖。另外，对于只分配一页的栈指针等，也要避免在初始化时出现跨页等情形。



### SWAP页回收错误

1. 错误现象

   设置可用页框为256页，SWAP区大小为4K页时。`swap.c`测试程序在分配到第768页触发了错误。

2. 调试过程

   + 由于触发错误的换出页过大，而qemu所能读取的扇区数有限，因此只能在板卡上进行调试。
   + 根据添加的打印信息进行分析，发现该页框再分配时页表项非空，由此可以推测如下错误原因：在物理页框全被占满，而将其中内容换出并将该页框再分配时，内部内容不为空，再分配时不为空的页表项进行了干扰。
   + 通过在每次分配时清空该物理页框，该问题得到解决。

3. 问题总结

   涉及到SWAP功能的页换出和换入时，需要关注内容的管理。涉及到物理页框的分配时，应当注意将其中无效旧值清空以免产生干扰。



### 进程回收错误

1. 错误现象

   在进程退出或被杀死时回收物理页，并分配给其他进程时产生了错误。

2. 调试过程

   + 首先推测是该页中信息在进程切换时还会使用，回收页时内容可能被更改。但根据gdb调试跟踪结果，其中内容在切换中与预期相符，且切换过程中并未分配新页，因此回收时只是更改页标记的方式并不会导致内容更改。可能有其他错误原因。
   + 回收部分未出错，因此转而考虑分配部分，使用bzero在分配时进行了清楚，然而仍然触发该错误。
   + 经助教提示，由于cache使用物理地址索引，复用物理页面后旧的数据仍可能保存在cache中造成干扰，且对于bzero的操作可能采取了绕过缓存的策略，导致缓存中的旧值保持不变。故只需在切换SATP寄存器时刷新物理内存即可。

3. 问题总结

   部分隐藏的错误可能涉及到板卡或qemu的内部实现，无法简单通过代码逻辑判断。在推测可能的错误原因后，也应当根据相关的物理实现结构分析可能的处理措施。



### 快照功能错误

1. 错误现象

   实现快照功能时，通过初始化将正本A、D位置高，快照时将D位清空，从而期望在写正本时触发写操作页缺失，进而进行页拷贝等相关处理。但实际并未触发该错误，导致功能无法实现。

2. 调试过程

   + 根据讲义描述，qemu会自动设置A、D位，而板卡A、D不符预期将会触发相关错误，故主要使用print对板卡进行调试。
   + 根据打印信息，发现板卡同样会自动设置A、D位，与讲义描述不符，故无法通过A、D位不负预期来引发相关异常进行处理。
   + 分析页表项结构，发现可以通过关闭写权限来触发写正本时的异常，且该设置方式可以同时应用于qemu和板卡。
   + 进一步进行调试发现，在关闭写权限、进行写正本时，所触发的异常类型也可能是写操作页缺失异常，因此需要在写权限异常和写操作页缺失异常的处理逻辑中都考虑写正本所触发的异常情况，并进行相关处理。

3. 问题总结

   在页表项等结构中，可能由不同设置可以起到相同功能。需要加深对具体结构类型的了解，尽量选择能同时适用qemu和板卡设计的设置方式，从而方便进行调试工作。



### qemu上swap功能测试错误

1. 错误现象

   在qemu上进行swap测试时，无法读写超过镜像的扇区，将会触发`block write error`错误。

2. 调试过程

   + 最开始时并未找到错误，以为是qemu自身实现问题。通过上板的print调试找到错误并通过swap功能测试。
   + 在后续实验环境设置中，偶然发现会分别在项目文件夹和`build`子文件夹中均生成`image`文件，且项目文件夹中的image文件夹在每次执行`make`指令时将逐渐增大，因此怀疑是所给的padding命令有误
   + 分析`Makefile`实现逻辑可知，应当设置`dd`命令参数为`of=${DIR_BUILD}/image`，更改设置后，qemu可以完成swap功能测试。

3. 问题总结：

   对于自行添加的`Makefile`命令，应当额外注意其文件参数的路径，以生成正确的测试对象。对于qemu和上板的现象不一致，也应当结合具体命令参数进行比对判断。


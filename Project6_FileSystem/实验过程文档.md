# Project_FileSystem 实验过程文档

+ 说明：prj6中关于磁盘布局、文件系统元数据、文件系统容量、初始化过程、多级路径解析等见[design_review.md](design_review.md)，本文主要介绍实验过程中遇到的具体问题及解决措施

### 临时块存储

1. 问题详情
   根据函数实际功能，在进行块清空，目录块切换等逻辑时，需要使用临时的数据块作为中间存储。如果使用局部变量进行实现，将会占用大量的栈空间。可能超出4K页的大小，增加内存分配设计的复杂性。

2. 解决方案
   经过函数功能梳理，发现只需要引入一个全局的临时块和临时inode，即可支持块清空逻辑以及ls功能中不改变当前目录块的递归寻找过程，只需要引入当前目录inode和当前目录块，即可支持cd的目录切换功能。因此，采用全局变量的方案支持函数应用中所需的临时块。

### 异常路径支持

1. 问题详情
   从设计的便捷性和全局变量考虑，对于多级路径，只能在分拆之后逐级进行处理，不易提前判断后续路径的合法性。如果全部命令均支持多级目录。如果所有命令均合法，可以直接设计一个统一接口，将传入的多级路径进行分拆，并分别对各级路径执行功能函数。但对一个非法的路径，由于命令功能不同，各级路径的合法条件也不同，就不能使用统一的接口。同时，应当考虑到一个非法的指令不能产生实质影响，例如，对于一个mkdir指令，如果最后一级路径出错，前面的目录也不应当创建。

2. 解决方案
   为了增强操作系统面对各种非法命令的鲁棒性，考虑在不同命令下根据命令执行条件及影响分别对多级路径进行解析和操作。对cd和ls操作，前序路径操作不会产生负面影响，因此可以支持多级路径。对于其余操作，非法命令情形较为复杂，因此使用单级路径实现。

### lseek相关

1. 问题详情

   根据测试文件，将会向文件多次写入之后，直接多次读取。因此本次设计的文件系统和linux实现有所不同，读写指针将分离，分别计算读写偏移。然而，lseek函数返回值与指针位置相关，而读写指针位置可能不同。

2. 解决方案

   更改API，增加rw参数，指定lseek操作对象为读指针或写指针。另外，对读写操作合法性判断有所不同。读操作不允许超过文件大小，从而避免读取未定义数据，而写操作允许，以便于写入大文件进行测试。